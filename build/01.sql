--TODO: use camel case

CREATE TABLE IF NOT EXISTS `users` (
	`user_id` SMALLINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
	`username` VARCHAR(32) NOT NULL,
	`displayname` VARCHAR(32) NOT NULL,
	`password` CHAR(32) NOT NULL,
	`active` TINYINT(1) UNSIGNED NOT NULL DEFAULT 1,
	`permission` TINYINT UNSIGNED NOT NULL DEFAULT 1,
	`last_login` TIMESTAMP,
	ADD CONSTRAINT username_ux UNIQUE (`username`),
	ADD CONSTRAINT displayname_ux UNIQUE (`displayname`)
) ENGINE = InnoDB CHARACTER SET utf8 COLLATE utf8_general_ci;

CREATE TABLE IF NOT EXISTS `api_keys` (
	`id` SMALLINT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
	`key` CHAR(40) NOT NULL,
	`owner` SMALLINT UNSIGNED NOT NULL,
	`active` TINYINT(1) UNSIGNED NOT NULL DEFAULT 1,
	ADD CONSTRAINT api_key_ux UNIQUE (`key`),
	FOREIGN KEY(`owner`) REFERENCES users(`owner`) ON DELETE CASCADE
) ENGINE == InnoDB CHARACTER SET utf8 COLLATE utf8_general_ci;

--TODO: make token the primary key
CREATE TABLE IF NOT EXISTS `sessions` (
	`session_id` INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
	`created` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
	`key` SMALLINT UNSIGNED NOT NULL,
	`expiry` TIMESTAMP NOT NULL,
	`token` CHAR(40) NOT NULL,
	`total_requests` INT UNSIGNED NOT NULL DEFAULT 0,
	ADD CONSTRAINT session_token_ux UNIQUE (`token`),
	FOREIGN KEY(`owner`) REFERENCES users(`user_id`) ON DELETE CASCADE,
	FOREIGN KEY(`key`) REFERENCES api_keys(`id`) ON DELETE CASCADE
) ENGINE = InnoDB CHARACTER SET utf8 COLLATE utf8_general_ci;

CREATE TABLE IF NOT EXISTS `main_data` (
	`id` INT UNSIGNED NOT NULL AUTO_INCREMENT PRIMARY KEY,
	`date_recorded` DATETIME NOT NULL,
	`text` TEXT CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
	`owner` SMALLINT UNSIGNED NOT NULL,
	`archived` TINYINT(1) UNSIGNED NOT NULL DEFAULT 0,
	FOREIGN KEY(`owner`) REFERENCES users(`user_id`) ON DELETE CASCADE
) ENGINE = InnoDB CHARACTER SET utf8 COLLATE utf8_general_ci;

